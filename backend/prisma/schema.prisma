generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       String         @id @default(uuid())
  name                     String
  email                    String?        @unique
  phone                    String?        @unique
  password                 String?
  googleId                 String?        @unique
  authProvider             AuthProvider   @default(PHONE)
  profilePicture           String?
  company                  String?
  isVerified               Boolean        @default(false)
  isEmailVerified          Boolean        @default(false)
  isPhoneVerified          Boolean        @default(false)
  gender                   Gender?
  rating                   Float          @default(5.0)
  totalRides               Int            @default(0)
  totalRidesAsDriver       Int            @default(0)
  totalRidesAsPassenger    Int            @default(0)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime       @updatedAt
  bookingsAsPassenger      Booking[]      @relation("PassengerBookings")
  conversationsAsDriver    Conversation[] @relation("DriverConversations")
  conversationsAsPassenger Conversation[] @relation("PassengerConversations")
  sentMessages             Message[]      @relation("SentMessages")
  notifications            Notification[]
  ratingsGiven             Rating[]       @relation("RatingsGiven")
  ratingsReceived          Rating[]       @relation("RatingsReceived")
  ridesAsDriver            Ride[]         @relation("DriverRides")
  transactions             Transaction[]
  vehicles                 Vehicle[]
  wallet                   Wallet?

  @@index([phone])
  @@index([email])
  @@index([company])
  @@index([googleId])
}

model Vehicle {
  id           String      @id @default(uuid())
  userId       String
  vehicleType  VehicleType
  make         String
  model        String
  year         Int
  color        String?
  licensePlate String      @unique
  seats        Int
  isVerified   Boolean     @default(false)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  rides        Ride[]
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([licensePlate])
}

model Ride {
  id                String           @id @default(uuid())
  driverId          String
  vehicleId         String
  startLat          Float
  startLng          Float
  startAddress      String?
  endLat            Float
  endLng            Float
  endAddress        String?
  waypoints         Json?
  polyline          String
  geohashes         String[]
  departureTime     DateTime
  availableSeats    Int
  pricePerSeat      Float
  status            RideStatus       @default(SCHEDULED)
  isRecurring       Boolean          @default(false)
  recurrenceType    RecurrenceType   @default(NONE)
  recurrenceDays    Int[]
  recurrenceEndDate DateTime?
  sameCompanyOnly   Boolean          @default(false)
  genderPreference  GenderPreference @default(ANY)
  smokingAllowed    Boolean          @default(false)
  petsAllowed       Boolean          @default(false)
  musicAllowed      Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  bookings          Booking[]
  conversations     Conversation[]
  driver            User             @relation("DriverRides", fields: [driverId], references: [id], onDelete: Cascade)
  vehicle           Vehicle          @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([driverId, departureTime])
  @@index([status, departureTime])
  @@index([geohashes])
}

model Booking {
  id                  String        @id @default(uuid())
  rideId              String
  passengerId         String
  seatsBooked         Int
  pickupLat           Float
  pickupLng           Float
  pickupAddress       String?
  dropLat             Float
  dropLng             Float
  dropAddress         String?
  estimatedPickupTime DateTime?
  estimatedDropTime   DateTime?
  actualPickupTime    DateTime?
  actualDropTime      DateTime?
  status              BookingStatus @default(PENDING)
  totalAmount         Float
  pointsUsed          Int           @default(0)
  distanceTravelled   Float?
  passengerRating     Int?
  driverRating        Int?
  passengerReview     String?
  driverReview        String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  passenger           User          @relation("PassengerBookings", fields: [passengerId], references: [id], onDelete: Cascade)
  ride                Ride          @relation(fields: [rideId], references: [id], onDelete: Cascade)
  ratings             Rating[]
  transactions        Transaction[]

  @@index([rideId, status])
  @@index([passengerId, status])
  @@index([rideId, passengerId])
}

model Wallet {
  id           String        @id @default(uuid())
  userId       String        @unique
  balance      Float         @default(0)
  points       Int           @default(0)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Transaction {
  id               String              @id @default(uuid())
  userId           String
  walletId         String
  bookingId        String?
  type             TransactionType
  category         TransactionCategory
  amount           Float
  pointsChanged    Int                 @default(0)
  balanceBefore    Float
  balanceAfter     Float
  pointsBefore     Int
  pointsAfter      Int
  description      String
  paymentGatewayId String?
  createdAt        DateTime            @default(now())
  booking          Booking?            @relation(fields: [bookingId], references: [id])
  user             User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  wallet           Wallet              @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([walletId])
  @@index([bookingId])
}

model OTP {
  id         String   @id @default(uuid())
  identifier String
  otp        String
  type       OTPType
  expiresAt  DateTime
  verified   Boolean  @default(false)
  createdAt  DateTime @default(now())

  @@index([identifier, type])
}

model Notification {
  id        String           @id @default(uuid())
  userId    String
  title     String
  body      String
  type      NotificationType @default(OTHER)
  data      Json?
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([userId, read])
}

model Rating {
  id         String   @id @default(uuid())
  bookingId  String
  fromUserId String
  toUserId   String
  rating     Int
  review     String?
  createdAt  DateTime @default(now())
  booking    Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  fromUser   User     @relation("RatingsGiven", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUser     User     @relation("RatingsReceived", fields: [toUserId], references: [id], onDelete: Cascade)

  @@unique([bookingId, fromUserId])
  @@index([toUserId])
}

model Conversation {
  id            String    @id @default(uuid())
  rideId        String
  driverId      String
  passengerId   String
  lastMessageAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  driver        User      @relation("DriverConversations", fields: [driverId], references: [id], onDelete: Cascade)
  passenger     User      @relation("PassengerConversations", fields: [passengerId], references: [id], onDelete: Cascade)
  ride          Ride      @relation(fields: [rideId], references: [id], onDelete: Cascade)
  messages      Message[]

  @@unique([rideId, passengerId])
  @@index([driverId])
  @@index([passengerId])
  @@index([rideId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  senderId       String
  messageType    MessageType  @default(TEXT)
  content        String
  mediaUrl       String?
  isRead         Boolean      @default(false)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  sender         User         @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([senderId])
  @@index([createdAt])
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum VehicleType {
  CAR
  BIKE
}

enum RideStatus {
  SCHEDULED
  ONGOING
  COMPLETED
  CANCELLED
}

enum RecurrenceType {
  NONE
  DAILY
  WEEKDAYS
  WEEKENDS
  CUSTOM
}

enum GenderPreference {
  MALE
  FEMALE
  ANY
}

enum BookingStatus {
  PENDING
  ACCEPTED
  REJECTED
  CANCELLED
  COMPLETED
}

enum TransactionType {
  CREDIT
  DEBIT
}

enum TransactionCategory {
  RIDE_PAYMENT
  RIDE_EARNING
  WALLET_LOAD
  POINTS_REDEMPTION
  REFUND
}

enum OTPType {
  PHONE
  EMAIL
}

enum NotificationType {
  RIDE_MATCHED
  BOOKING_REQUEST
  BOOKING_ACCEPTED
  BOOKING_REJECTED
  RIDE_REMINDER
  PAYMENT
  OTHER
}

enum MessageType {
  TEXT
  IMAGE
  LOCATION
  SYSTEM
}

enum AuthProvider {
  PHONE
  EMAIL
  GOOGLE
}
