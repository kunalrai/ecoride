# EcoRide Backend - Render Deployment Guide

This guide will help you deploy the EcoRide backend API to Render.

## Prerequisites

1. **GitHub Account** - Your code should be pushed to a GitHub repository
2. **Render Account** - Sign up at [render.com](https://render.com)
3. **Environment Variables** - Have all required API keys and credentials ready

## Deployment Steps

### Option 1: Using render.yaml (Recommended)

This method uses the `render.yaml` file in the backend directory for infrastructure-as-code deployment.

1. **Push your code to GitHub**
   ```bash
   git add .
   git commit -m "Add Render deployment configuration"
   git push origin main
   ```

2. **Connect to Render**
   - Go to [Render Dashboard](https://dashboard.render.com)
   - Click "New +" → "Blueprint"
   - Connect your GitHub repository
   - Select the repository containing your code
   - Render will automatically detect the `render.yaml` file

3. **Configure Environment Variables**

   The following environment variables need to be set in Render dashboard:

   **Required Variables:**
   - `TWILIO_ACCOUNT_SID` - Your Twilio Account SID
   - `TWILIO_AUTH_TOKEN` - Your Twilio Auth Token
   - `TWILIO_PHONE_NUMBER` - Your Twilio Phone Number
   - `SMTP_USER` - Your SMTP email address
   - `SMTP_PASS` - Your SMTP password
   - `FIREBASE_PROJECT_ID` - Your Firebase Project ID
   - `FIREBASE_PRIVATE_KEY` - Your Firebase Private Key (keep the quotes and newlines)
   - `FIREBASE_CLIENT_EMAIL` - Your Firebase Client Email
   - `RAZORPAY_KEY_ID` - Your Razorpay Key ID
   - `RAZORPAY_KEY_SECRET` - Your Razorpay Key Secret
   - `GOOGLE_MAPS_API_KEY` - Your Google Maps API Key
   - `GEMINI_API_KEY` - Your Gemini AI API Key

   **Auto-configured Variables:**
   - `DATABASE_URL` - Automatically set from the PostgreSQL database
   - `JWT_SECRET` - Automatically generated by Render
   - `NODE_ENV` - Set to "production"
   - `PORT` - Set to 5000

4. **Deploy**
   - Click "Apply" to start the deployment
   - Render will:
     - Create a PostgreSQL database
     - Install dependencies
     - Generate Prisma Client
     - Push database schema
     - Build TypeScript code
     - Start the server

### Option 2: Manual Setup

If you prefer manual setup:

1. **Create PostgreSQL Database**
   - Go to Render Dashboard
   - Click "New +" → "PostgreSQL"
   - Name: `ecoride-db`
   - Plan: Free
   - Click "Create Database"
   - Copy the "Internal Database URL"

2. **Create Web Service**
   - Click "New +" → "Web Service"
   - Connect your GitHub repository
   - Configure:
     - **Name:** ecoride-backend
     - **Environment:** Node
     - **Region:** Oregon (or closest to your users)
     - **Branch:** main
     - **Root Directory:** backend
     - **Build Command:** `npm install && npm run build`
     - **Start Command:** `npm start`
     - **Plan:** Free

3. **Add Environment Variables**
   - In the web service settings, go to "Environment"
   - Add all required variables listed above
   - For `DATABASE_URL`, paste the Internal Database URL from step 1

4. **Deploy**
   - Click "Create Web Service"
   - Wait for deployment to complete

## Post-Deployment

### 1. Verify Deployment

Once deployed, your API will be available at:
```
https://ecoride-backend.onrender.com
```

Test the endpoints:
- Health Check: `https://ecoride-backend.onrender.com/health`
- API Documentation: `https://ecoride-backend.onrender.com/api-docs`

### 2. Database Management

Access your database:
- **Option 1:** Use Render's built-in database browser
- **Option 2:** Connect using the External Database URL with a PostgreSQL client
- **Option 3:** Use Prisma Studio locally:
  ```bash
  # Set DATABASE_URL to your Render database External URL
  DATABASE_URL="postgresql://..." npx prisma studio
  ```

### 3. Monitor Logs

View application logs:
- Go to your web service in Render Dashboard
- Click on "Logs" tab
- Monitor for any errors or issues

### 4. Set Up Custom Domain (Optional)

To use a custom domain:
- Go to your web service settings
- Click "Settings" → "Custom Domain"
- Follow instructions to add your domain
- Update DNS records as instructed

## Environment Variables Reference

| Variable | Description | Required | Example |
|----------|-------------|----------|---------|
| `NODE_ENV` | Environment mode | Yes | production |
| `PORT` | Server port | Yes | 5000 |
| `DATABASE_URL` | PostgreSQL connection string | Yes | Auto-generated |
| `JWT_SECRET` | JWT signing secret | Yes | Auto-generated |
| `JWT_EXPIRES_IN` | JWT expiration time | Yes | 7d |
| `TWILIO_ACCOUNT_SID` | Twilio Account SID | Yes | ACxxxxx |
| `TWILIO_AUTH_TOKEN` | Twilio Auth Token | Yes | xxxxxx |
| `TWILIO_PHONE_NUMBER` | Twilio Phone Number | Yes | +1234567890 |
| `SMTP_HOST` | SMTP server host | Yes | smtp.gmail.com |
| `SMTP_PORT` | SMTP server port | Yes | 587 |
| `SMTP_USER` | SMTP username/email | Yes | your@email.com |
| `SMTP_PASS` | SMTP password | Yes | xxxxxx |
| `FIREBASE_PROJECT_ID` | Firebase Project ID | Yes | your-project-id |
| `FIREBASE_PRIVATE_KEY` | Firebase Private Key | Yes | -----BEGIN... |
| `FIREBASE_CLIENT_EMAIL` | Firebase Client Email | Yes | xxx@xxx.iam.gserviceaccount.com |
| `RAZORPAY_KEY_ID` | Razorpay Key ID | Yes | rzp_test_xxxxx |
| `RAZORPAY_KEY_SECRET` | Razorpay Key Secret | Yes | xxxxxx |
| `GOOGLE_MAPS_API_KEY` | Google Maps API Key | Yes | AIzaxxxxx |
| `GEMINI_API_KEY` | Gemini AI API Key | Yes | AIzaxxxxx |
| `OTP_EXPIRY_MINUTES` | OTP expiration time | No | 10 |
| `MAX_RIDE_DEVIATION_KM` | Max ride deviation | No | 5 |
| `POINTS_PER_RUPEE` | Points per rupee | No | 10 |

## Troubleshooting

### Build Fails

**Issue:** Build command fails with Prisma errors

**Solution:**
- Ensure `DATABASE_URL` is set correctly
- Check that Prisma schema is valid
- Verify all dependencies are in `package.json`

### Database Connection Issues

**Issue:** Cannot connect to database

**Solution:**
- Use the "Internal Database URL" for web service connections
- Verify the database is in the same region as your web service
- Check firewall settings

### Environment Variables Not Working

**Issue:** App can't read environment variables

**Solution:**
- Ensure all variables are set in Render dashboard
- Check variable names are exact (case-sensitive)
- For multiline variables like `FIREBASE_PRIVATE_KEY`, ensure proper formatting

### App Crashes on Startup

**Issue:** Server crashes immediately after deployment

**Solution:**
- Check logs in Render dashboard
- Verify all required environment variables are set
- Ensure database is accessible
- Check that `dist/server.js` exists after build

## Free Tier Limitations

Render's free tier includes:
- **Web Service:** 750 hours/month, spins down after 15 minutes of inactivity
- **PostgreSQL:** 90-day expiration, 1GB storage
- **Bandwidth:** Limited

**Important Notes:**
- Service will "cold start" after inactivity (takes 30-60 seconds)
- Database expires after 90 days on free tier
- Consider upgrading for production use

## Updating Your Deployment

To deploy updates:

1. **Push code to GitHub:**
   ```bash
   git add .
   git commit -m "Your update message"
   git push origin main
   ```

2. **Automatic deployment:**
   - Render automatically deploys when you push to the connected branch
   - Monitor deployment progress in Render dashboard

3. **Manual deployment:**
   - Go to your web service in Render dashboard
   - Click "Manual Deploy" → "Deploy latest commit"

## Security Best Practices

1. **Never commit secrets** - Use environment variables for all sensitive data
2. **Use strong JWT secrets** - Let Render auto-generate them
3. **Enable CORS properly** - Configure allowed origins for production
4. **Keep dependencies updated** - Regularly update npm packages
5. **Monitor logs** - Check for suspicious activity
6. **Use HTTPS only** - Render provides free SSL certificates

## Support

- **Render Documentation:** [docs.render.com](https://docs.render.com)
- **Render Community:** [community.render.com](https://community.render.com)
- **Prisma Documentation:** [prisma.io/docs](https://www.prisma.io/docs)

## Next Steps

After successful deployment:
1. Update your frontend to use the new API URL
2. Test all API endpoints using Swagger UI
3. Set up monitoring and alerts
4. Configure backup strategy for database
5. Consider upgrading to paid tier for production
